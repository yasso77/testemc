{% extends 'master.html' %}

{% block content %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css">

<style>
/* (Your styles remain unchanged) */
</style>

<div class="pagetitle">
    <h1>Workspace: <span style="color:#4154f1;">{{ viewScope }}</span></h1>
</div>

<section class="section">
    <div class="section-card">

        <table id="patientsTable" class="display nowrap" style="width:100%">
            <thead>
                <tr>
                    <th>ID Code</th>
                    <th>Patient Name</th>
                    <th>Contact</th>
                    <th>Case Type</th>
                    <th>Created At</th>
                    <th>Created By</th>
                    <th>Expected</th>
                    <th>Status</th>
                    <th class="text-center">Operations</th>
                </tr>
            </thead>

            <tbody id="patient-body">
                {% include 'callcenter/patient_rows.html' %}
            </tbody>
        </table>

        <!-- Loader -->
        <div id="loader" class="text-center my-4" style="display:none;">
            <span class="spinner-border text-primary"></span>
        </div>

    </div>
</section>

<!-- JS (ORDER MATTERS) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>

<script>
/* DataTables (NO pagination) */
$(document).ready(function () {
    $('#patientsTable').DataTable({
        paging: false,        // ðŸ”´ REQUIRED
        info: false,
        order: [],
        searching: true,
        language: {
            search: "SEARCH:"
        }
    });
});
</script>

<script>
/* Infinite Scroll */
let page = 1;
let loading = false;
let hasNext = true;

$(window).on('scroll', function () {
    if (!hasNext || loading) return;

    if ($(window).scrollTop() + $(window).height() + 150 >= $(document).height()) {
        loadMore();
    }
});

function loadMore() {
    loading = true;
    page++;
    $('#loader').show();

    $.ajax({
        url: "?page=" + page,
        headers: { "X-Requested-With": "XMLHttpRequest" },
        success: function (res) {
            $('#patient-body').append(res.html);
            hasNext = res.has_next;
            loading = false;
            $('#loader').hide();
        }
    });
}
</script>

{% endblock %}
