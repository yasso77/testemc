{% extends 'master.html' %}

{% block content %}
<style>
    /* Professional Layout Accents */
    .workspace-header {
        background: linear-gradient(90deg, #ffffff 0%, #f8f9fa 100%);
        border: 1px solid #e2e8f0;
        border-left: 5px solid #0d6efd;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
    }

    .info-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #64748b;
        display: block;
        margin-bottom: 2px;
    }

    .info-data {
        font-weight: 700;
        color: #1e293b;
        font-size: 1.1rem;
    }

    /* Modernized Timeline */
    .timeline-container {
        position: relative;
        padding: 10px 0;
    }

    .timeline-item {
        position: relative;
        padding-left: 45px;
        margin-bottom: 30px;
    }

    .timeline-item::before {
        content: "";
        position: absolute;
        left: 19px;
        top: 24px;
        bottom: -36px;
        width: 2px;
        background: #e2e8f0;
    }

    .timeline-item:last-child::before {
        display: none;
    }

    .timeline-marker {
        position: absolute;
        left: 10px;
        top: 0;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #fff;
        border: 3px solid #cbd5e1;
        z-index: 2;
    }

    .timeline-card {
        background: #fff;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        border-left: 4px solid #cbd5e1; /* Default Border */
        padding: 18px;
        transition: all 0.2s ease;
    }

    /* Outcome specific colors */
    .border-confirmed { border-left-color: #10b981 !important; }
    .border-canceled { border-left-color: #ef4444 !important; }
    .border-rescheduled { border-left-color: #f59e0b !important; }
    .border-default { border-left-color: #3b82f6 !important; }

    .marker-confirmed { border-color: #10b981 !important; background: #10b981 !important; }
    .marker-canceled { border-color: #ef4444 !important; background: #ef4444 !important; }
    .marker-rescheduled { border-color: #f59e0b !important; background: #f59e0b !important; }

    /* Form Design */
    .form-section-label {
        font-size: 0.9rem;
        font-weight: 700;
        color: #475569;
        margin-bottom: 15px;
        padding-bottom: 5px;
        border-bottom: 1px solid #f1f5f9;
        display: block;
    }

    .custom-form-group {
        background: #f8fafc;
        padding: 20px;
        border-radius: 10px;
        border: 1px solid #f1f5f9;
    }

    .btn-save {
        padding: 10px 30px;
        font-weight: 600;
        border-radius: 8px;
        box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
    }
</style>

<div class="pagetitle">
    <h1>Follow Up Reservation</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'index' %}">Home</a></li>
            <li class="breadcrumb-item">Call Center</li>
            <li class="breadcrumb-item active">Follow Up Workstation</li>
        </ol>
    </nav>
</div>

<section class="section">
    <div class="workspace-header shadow-sm">
        <div class="row text-center text-md-start">
            <div class="col-md-3 border-end">
                <span class="info-label">Reservation Code</span>
                <span class="info-data text-primary">{{ patient.reservationCode }}</span>
            </div>
            <div class="col-md-4 border-end">
                <span class="info-label">Patient Full Name</span>
                <span class="info-data">{{ patient.fullname }}</span>
            </div>
            <div class="col-md-3 border-end">
                <span class="info-label">Case Category</span>
                <span class="info-data text-muted">{{ patient.sufferedcase__caseName|default:"General" }}</span>
            </div>
            <div class="col-md-2">
                <span class="info-label">Status</span>
                <span class="badge {% if patient.attendanceDate %}bg-success{% else %}bg-warning{% endif %}">
                    {% if patient.attendanceDate %}Attended{% else %}Ongoing{% endif %}
                </span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-5">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <span class="form-section-label">SUBMIT LOG ENTRY</span>
                    <form method="post" id="followUpForm">
                        {% csrf_token %}
                        
                        <div class="mb-4">
                            <label class="form-label fw-bold small text-secondary">CALL OUTCOME</label>
                            <div id="outcomeGroup" class="d-flex flex-wrap gap-2">
                                {% for radio in form.outcome %}
                                    <div class="flex-fill">
                                        {{ radio.tag }}
                                        <label class="btn btn-outline-light text-dark border w-100 py-2 small" for="{{ radio.id_for_label }}">
                                            {{ radio.choice_label }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold small text-secondary">REMARKS / NOTES</label>
                            {{ form.remarks }}
                        </div>

                        <div class="custom-form-group mb-4">
                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label fw-bold small text-secondary">NEXT CONTACT</label>
                                    {{ form.nextFollow }}
                                </div>
                                <div class="col-6">
                                    <label class="form-label fw-bold small text-secondary">CONFIRM DATE</label>
                                    {{ form.confirmationDate }}
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-save">Update Track</button>
                            <a href="{% url 'reservationList' %}" class="btn btn-link text-muted btn-sm">Return to List</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 pt-4 px-4">
                    <h5 class="card-title m-0">Interaction Timeline</h5>
                </div>
                <div class="card-body px-4">
                    <div class="timeline-container">
                        {% for track in calltracks %}
                        <div class="timeline-item">
                            <div class="timeline-marker 
                                {% if track.outcome == 'Confirmed' %}marker-confirmed
                                {% elif track.outcome == 'Canceled' %}marker-canceled
                                {% elif track.outcome == 'Rescheduled' %}marker-rescheduled{% endif %}">
                            </div>
                            <div class="timeline-card 
                                {% if track.outcome == 'Confirmed' %}border-confirmed
                                {% elif track.outcome == 'Canceled' %}border-canceled
                                {% elif track.outcome == 'Rescheduled' %}border-rescheduled
                                {% else %}border-default{% endif %}">
                                
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-bold text-uppercase small">{{ track.outcome }}</span>
                                    <span class="text-muted small"><i class="bi bi-person-circle"></i> {{ track.createdBy|default:"Agent" }}</span>
                                </div>
                                
                                <p class="mb-3 text-secondary">{{ track.remarks }}</p>
                                
                                <div class="row g-0 border-top pt-2 mt-2">
                                    <div class="col-6">
                                        <span class="info-label" style="font-size: 9px;">Follow Up</span>
                                        <span class="small fw-bold">{{ track.nextFollow|default:"--" }}</span>
                                    </div>
                                    <div class="col-6 border-start ps-3">
                                        <span class="info-label" style="font-size: 9px;">Confirmation</span>
                                        <span class="small fw-bold">{{ track.confirmationDate|default:"--" }}</span>
                                    </div>
                                </div>
                                
                                <div class="text-end mt-2">
                                    <span class="badge bg-light text-muted fw-normal" style="font-size: 10px;">
                                        Log: {{ track.createdDate }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-5">
                            <img src="https://cdn-icons-png.flaticon.com/512/5058/5058432.png" width="80" class="opacity-25 mb-3">
                            <p class="text-muted">No interactions logged for this reservation.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const outcomeRadios = document.querySelectorAll('#outcomeGroup input[type="radio"]');
        const nextFollowInput = document.querySelector("input[name='nextFollow']");
        const confirmationInput = document.querySelector("input[name='confirmationDate']");
    
        if (!nextFollowInput || !confirmationInput || outcomeRadios.length === 0) {
            return;
        }
    
        function updateFormState() {
            const selectedOutcome = Array.from(outcomeRadios).find(radio => radio.checked)?.value;
    
            if (selectedOutcome === "Rescheduled") {
                confirmationInput.disabled = true;
                confirmationInput.required = false;
                confirmationInput.value = "";
                nextFollowInput.disabled = false;
                nextFollowInput.required = true;
            } else if (selectedOutcome === "Confirmed") {
                nextFollowInput.disabled = true;
                nextFollowInput.required = false;
                nextFollowInput.value = "";
                confirmationInput.disabled = false;
                confirmationInput.required = true;
            } else if (selectedOutcome === "Canceled") {
                nextFollowInput.disabled = true;
                nextFollowInput.required = false;
                nextFollowInput.value = "";
                confirmationInput.value = "";
                confirmationInput.disabled = true;
                confirmationInput.required = false;
            } else {
                nextFollowInput.disabled = false;
                nextFollowInput.required = false;
                confirmationInput.disabled = false;
                confirmationInput.required = false;
            }
        }
    
        outcomeRadios.forEach(radio => {
            radio.addEventListener("change", updateFormState);
        });
    
        updateFormState();
    });
</script>
{% endblock %}