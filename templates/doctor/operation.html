{% extends 'master.html'%}

{% block content %}
<style>
  body {
    background: #F1F5F9;
    font-family: "Segoe UI", Tahoma, sans-serif;
  }

  .container {
    width: 95%;
    max-width: 800px;
    margin: auto;
    display: flex;
    flex-direction: column;
    gap: 20px;
    direction: rtl;
  }

  /* Search Bar */
  .search-bar {
    display: flex;
    justify-content: center;
    width: 100%;
  }

  .search-bar input {
    flex: 1;
    padding: 14px 18px;
    font-size: 18px;
    border: 1px solid #CBD5E1;
    border-radius: 12px;
    outline: none;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }

  .search-bar input:focus {
    border-color: #2563EB;
    box-shadow: 0 2px 8px rgba(37,99,235,0.25);
  }

  .search-bar button {
    margin-right: 10px;
    padding: 14px 30px;
    font-size: 18px;
    font-weight: bold;
    background: #2563EB;
    color: white;
    border: none;
    border-radius: 12px;
    cursor: pointer;
  }

  .search-bar button:hover {
    background: #1E40AF;
  }

  /* Loader */
  .loader {
    display: none;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #195a7a;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: auto;
  }
  @keyframes spin { 0%{transform:rotate(0)}100%{transform:rotate(360deg)} }

  /* Patient Info Card */
  .middle-bar {
    background: white;
    border-radius: 15px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }
  .patient-info {
    font-size: 22px;
    font-weight: bold;
    margin: 8px 0;
  }

  /* Progress Circle */
  .progress-circle {
    position: relative;
    width: 140px;
    height: 140px;
    margin: 20px auto;
  }

  .progress-circle svg { transform: rotate(-90deg); width: 100%; height: 100%; }
  .progress-bg { fill: none; stroke: #E5E7EB; stroke-width: 12; }
  .progress-value { fill: none; stroke-width: 12; stroke-linecap: round; transition: stroke-dashoffset 0.5s ease, stroke 0.5s ease; }

  .progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 28px;
    font-weight: bold;
  }

  .ratio {
    text-align: center;
    font-size: 18px;
    margin-top: 8px;
  }

  /* Action Buttons */
  .bottom {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-top: 20px;
    align-items: center; 
  }

  .bottom button {
    width: 100%;
    padding: 20px;
    border: none;
    border-radius: 12px;
    font-size: 26px;
    font-weight: bold;
    color: white;
    cursor: pointer;
    transition: 0.2s;
  }
  .bottom button.green { background: #10B981; }
  .bottom button.red { background: #DC2626; }
  .bottom button:hover { opacity: 0.9; }

  /* Disabled */
  .btn-same:disabled,
  .btn-operation:disabled { cursor: not-allowed; opacity: 0.7; }
</style>


<section class="section">
  <div class="container">

    <!-- Search -->
    <div class="search-bar">
      <input type="text" id="fileNumber" placeholder="اكتب رقم الملف أو امسحه الباركود">
      <button onclick="searchPatient()">بحث</button>
    </div>

    <!-- Loader -->
    <div id="loader" class="loader"></div>

    <!-- Patient Info -->
    <form method="post" action="{% url 'doctorPatientvisit' %}">
      {% csrf_token %}
      <div class="middle-bar" id="patient-info">
        <div class="patient-info">اسم المريض: -</div>
        <div class="patient-info">رقم الملف: -</div>

        <!-- Circle Progress -->
        <div class="progress-circle">
          <svg>
            <circle class="progress-bg" cx="70" cy="70" r="60"></circle>
            <circle class="progress-value" cx="70" cy="70" r="60"></circle>
          </svg>
          <div class="progress-text" id="percent">{{precent}}%</div>
        </div>
        <div class="ratio" id="ratio">{{ratio}}</div>
      </div>

      <input type="hidden" id="hdfpatientid" name="hdfpatientid" />

      <!-- Buttons -->
      <div class="bottom" >
        <button name="btnOperation" disabled id="btnOperation" class="green btn-operation">عملية</button>
        <button name="btnBad" style="width: 200px !important;" disabled id="btnBad" class="red btn-same">خسارة مريض</button>
      </div>
    </form>
  </div>
</section>


<script>
  async function searchPatient() {
    const fileNumber = document.getElementById("fileNumber").value.trim();
    const loader = document.getElementById("loader");
    const patientInfoBox = document.getElementById("patient-info");
    const btnOperation = document.getElementById("btnOperation");
    const btnBad = document.getElementById("btnBad");

    btnOperation.disabled = true;
    btnBad.disabled = true;

    if (!fileNumber) { alert("⚠️ الرجاء إدخال رقم الملف"); return; }

    try {
      loader.style.display = "block";
      patientInfoBox.innerHTML = "";

      const response = await fetch(`/get_patient_info/${encodeURIComponent(fileNumber)}/`);
      if (!response.ok) throw new Error("لم يتم العثور على المريض");
      const data = await response.json();

      if (data && Object.keys(data).length > 0) {
        patientInfoBox.innerHTML = `
          <div class="patient-info"><strong>اسم المريض:</strong> ${data.name || "-"}</div>
          <div class="patient-info"><strong>رقم الملف:</strong> ${data.fileserial || "-"}</div>

          <div class="progress-circle">
            <svg>
              <circle class="progress-bg" cx="70" cy="70" r="60"></circle>
              <circle class="progress-value" cx="70" cy="70" r="60"></circle>
            </svg>
            <div class="progress-text" id="percent">{{precent}}%</div>
          </div>
          <div class="ratio" id="ratio">{{ratio}}</div>
        `;
        document.getElementById("hdfpatientid").value = data.patientID || "";
        btnOperation.disabled = false;
        btnBad.disabled = false;

        // Update circle after loading
        updateCircle(parseFloat("{{precent}}") || 0);
      } else { throw new Error("⚠️ لا توجد بيانات لهذا المريض"); }
    } catch (error) {
      alert(error.message || "حدث خطأ أثناء جلب البيانات");
      console.error(error);
    } finally { loader.style.display = "none"; }
  }

  function updateCircle(percent) {
    const circle = document.querySelector(".progress-value");
    if (!circle) return;
    const radius = circle.r.baseVal.value;
    const circumference = 2 * Math.PI * radius;

    circle.style.strokeDasharray = circumference;
    circle.style.strokeDashoffset = circumference;

    const offset = circumference - (percent / 100) * circumference;
    circle.style.strokeDashoffset = offset;

    // Change color dynamically
    if (percent < 50) {
      circle.style.stroke = "#DC2626"; // red
    } else if (percent < 80) {
      circle.style.stroke = "#F97316"; // orange
    } else {
      circle.style.stroke = "#10B981"; // green
    }

    // Update text
    document.getElementById("percent").innerText = percent + "%";
  }

  // Initialize on load
  document.addEventListener("DOMContentLoaded", () => {
    updateCircle(parseFloat("{{precent}}") || 0);
  });

  
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const input = document.getElementById("fileNumber");
    input.focus(); // cursor ready for scanning

    // listen for Enter after scanning
    input.addEventListener("keypress", function (event) {
      if (event.key === "Enter") {
        event.preventDefault(); // stop form submitting
        searchPatient(); // run search automatically
      }
    });
  });
</script>
{% endblock %}
