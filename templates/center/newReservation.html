{% extends 'master.html'%}

{% block content %}
<style>
    .form-group { margin-bottom: 1.5rem; }
    .text-danger { color: red; }
    .table th, .table td { text-align: center; vertical-align: middle; }
    .left { text-align: left !important; font-weight: 500; }
    .custom-radio { transform: scale(1.3); margin: 5px; }
    .card-title { font-size: 1.1rem; font-weight: 600; color: #012970; }
    .section-header { border-bottom: 2px solid #f6f9ff; margin-bottom: 20px; padding-bottom: 10px; }
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        function toggleReferralField() {
            let reservationType = $("#{{ form.reservationType.id_for_label }}").val();
            let referralField = $("#{{ form.referral.id_for_label }}");
            if (reservationType === "FV") {
                referralField.prop("disabled", false);
            } else {
                referralField.prop("disabled", true).val("");
            }
        }
        toggleReferralField();
        $("#{{ form.reservationType.id_for_label }}").change(function () {
            toggleReferralField();
        });
    });
</script>

<div class="pagetitle">
    <h1>New Reservation</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{%url 'index'%}">Home</a></li>
            <li class="breadcrumb-item">Center</li>
            <li class="breadcrumb-item active">Add New Reservation</li>
        </ol>
    </nav>
</div>

<section class="section">
    <form method="post" id="myform" class="form-horizontal">
        {% csrf_token %}
        
        <div class="row">
            <div class="col-lg-12">

                   <div class="card">
                    <div class="card-body">
                        <h5 class="card-title section-header"><i class="bi bi-person"></i> Patient Information</h5>
                        <div class="row">
                             <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="{{ form.fullname.id_for_label }}" class="col-sm-4 col-form-label">Full Name<span class="text-danger">*</span></label>
                                    <div class="col-sm-8">{{ form.fullname }} {% if form.fullname.errors %}<div class="text-danger small">{{ form.fullname.errors }}</div>{% endif %}</div>
                                </div>
                            </div>
                              <div class="col-md-6">
                                <div class="form-group row">
                                    <label class="col-sm-4 col-form-label">Gender<span class="text-danger">*</span></label>
                                    <div class="col-sm-8">
                                        {% for radio in form.gender %}
                                        <div class="form-check form-check-inline">
                                            {{ radio.tag }} <label class="form-check-label">{{ radio.choice_label }}</label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="id_mobile" class="col-sm-4 col-form-label">Mobile<span class="text-danger">*</span></label>
                                    <div class="col-sm-8">
                                        <input type="text" id="id_mobile" name="mobile" maxlength="12" class="form-control" required>
                                        <div id="mobile-validation-message" class="alert alert-warning mt-2" style="display: none;"></div>
                                    </div>
                                </div>
                            </div>
                           
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="id_othermobile" class="col-sm-4 col-form-label">Other Mobile</label>
                                    <div class="col-sm-8"><input type="text" id="id_othermobile" name="othermobile" maxlength="12" class="form-control"></div>
                                </div>
                            </div>
                          
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="{{ form.birthdate.id_for_label }}" class="col-sm-4 col-form-label">Birth Date</label>
                                    <div class="col-sm-8">{{ form.birthdate }}</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="{{ form.city.id_for_label }}" class="col-sm-4 col-form-label">City<span class="text-danger">*</span></label>
                                    <div class="col-sm-8">{{ form.city }}</div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-group row">
                                    <label for="{{ form.address.id_for_label }}" class="col-sm-2 col-form-label">Address</label>
                                    <div class="col-sm-10">{{ form.address }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title section-header"><i class="bi bi-info-circle"></i> Reservation Details</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="{{ form.reservationType.id_for_label }}" class="col-sm-4 col-form-label">Type<span class="text-danger">*</span></label>
                                    <div class="col-sm-8">{{ form.reservationType }} {% if form.reservationType.errors %}<div class="text-danger small">{{ form.reservationType.errors }}</div>{% endif %}</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="{{ form.referral.id_for_label }}" class="col-sm-4 col-form-label">Referral</label>
                                    <div class="col-sm-8">{{ form.referral }} {% if form.referral.errors %}<div class="text-danger small">{{ form.referral.errors }}</div>{% endif %}</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="{{ form.organizationID.id_for_label }}" class="col-sm-4 col-form-label">Organization<span class="text-danger">*</span></label>
                                    <div class="col-sm-8">{{ form.organizationID }} {% if form.organizationID.errors %}<div class="text-danger small">{{ form.organizationID.errors }}</div>{% endif %}</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="{{ form.checkUpprice.id_for_label }}" class="col-sm-4 col-form-label">Price <span class="text-danger">*</span></label>
                                    <div class="col-sm-8">{{ form.checkUpprice }} {% if form.checkUpprice.errors %}<div class="text-danger small">{{ form.checkUpprice.errors }}</div>{% endif %}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

             

                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title section-header"><i class="bi bi-heart-pulse"></i> Medical History</h5>
                        
                        <div class="form-group row">
                            <label for="{{ form.sufferedcaseByPatient.id_for_label }}" class="col-sm-3 col-form-label">Case Complaint<span class="text-danger">*</span></label>
                            <div class="col-sm-9">{{ form.sufferedcaseByPatient }}</div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label">Willing to get rid of glass? <span class="text-danger">*</span></label>
                                <div id="rideglass-error" class="text-danger small"></div>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="rideglass" id="rideglassYes" value="Y" {% if form.rideglass.value == "Y" %}checked{% endif %}>
                                        <label class="form-check-label" for="rideglassYes">YES</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="rideglass" id="rideglassNo" value="N" {% if form.rideglass.value == "N" %}checked{% endif %}>
                                        <label class="form-check-label" for="rideglassNo">NO</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Contact lens (Last 2 weeks)? <span class="text-danger">*</span></label>
                                <div id="wearingconduct-error" class="text-danger small"></div>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="wearingconduct" id="wearingYes" value="Y" {% if form.wearingconduct.value == "Y" %}checked{% endif %}>
                                        <label class="form-check-label" for="wearingYes">YES</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="wearingconduct" id="wearingNo" value="N" {% if form.wearingconduct.value == "N" %}checked{% endif %}>
                                        <label class="form-check-label" for="wearingNo">NO</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive mt-3">
                            <table class="table table-bordered table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th class="left">Disease</th>
                                        <th>Self</th>
                                        <th>Relative</th>
                                        <th class="left">Disease</th>
                                        <th>Self</th>
                                        <th>Relative</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="left">DIABETES</td>
                                        <td><input type="radio" name="medical_conditions[DIABETES]" value="self" class="form-check-input custom-radio"></td>
                                        <td><input type="radio" name="medical_conditions[DIABETES]" value="relative" class="form-check-input custom-radio"></td>
                                        <td class="left">HEART DISEASE</td>
                                        <td><input type="radio" name="medical_conditions[HEART DISEASE]" value="self" class="form-check-input custom-radio"></td>
                                        <td><input type="radio" name="medical_conditions[HEART DISEASE]" value="relative" class="form-check-input custom-radio"></td>
                                    </tr>
                                    <tr>
                                        <td class="left">HTN</td>
                                        <td><input type="radio" name="medical_conditions[HTN]" value="self" class="form-check-input custom-radio"></td>
                                        <td><input type="radio" name="medical_conditions[HTN]" value="relative" class="form-check-input custom-radio"></td>
                                        <td class="left">ASTHMA ALLERGY</td>
                                        <td><input type="radio" name="medical_conditions[ASTHMA ALLERGY]" value="self" class="form-check-input custom-radio"></td>
                                        <td><input type="radio" name="medical_conditions[ASTHMA ALLERGY]" value="relative" class="form-check-input custom-radio"></td>
                                    </tr>
                                    <tr>
                                        <td class="left">CANCER</td>
                                        <td><input type="radio" name="medical_conditions[CANCER]" value="self" class="form-check-input custom-radio"></td>
                                        <td><input type="radio" name="medical_conditions[CANCER]" value="relative" class="form-check-input custom-radio"></td>
                                        <td class="left">GLAUCOMA</td>
                                        <td><input type="radio" name="medical_conditions[GLAUCOMA]" value="self" class="form-check-input custom-radio"></td>
                                        <td><input type="radio" name="medical_conditions[GLAUCOMA]" value="relative" class="form-check-input custom-radio"></td>
                                    </tr>
                                    <tr>
                                        <td class="left">CATARACT</td>
                                        <td><input type="radio" name="medical_conditions[CATARACT]" value="self" class="form-check-input custom-radio"></td>
                                        <td><input type="radio" name="medical_conditions[CATARACT]" value="relative" class="form-check-input custom-radio"></td>
                                        <td class="left">RETINAL D.</td>
                                        <td><input type="radio" name="medical_conditions[RETINAL D.]" value="self" class="form-check-input custom-radio"></td>
                                        <td><input type="radio" name="medical_conditions[RETINAL D.]" value="relative" class="form-check-input custom-radio"></td>
                                    </tr>
                                    <tr>
                                        <td class="left">EYE SURGERY</td>
                                        <td><input type="radio" name="medical_conditions[EYE SURGERY]" value="self" class="form-check-input custom-radio"></td>
                                        <td><input type="radio" name="medical_conditions[EYE SURGERY]" value="relative" class="form-check-input custom-radio"></td>
                                        <td class="left">EYE INJURY</td>
                                        <td><input type="radio" name="medical_conditions[EYE INJURY]" value="self" class="form-check-input custom-radio"></td>
                                        <td><input type="radio" name="medical_conditions[EYE INJURY]" value="relative" class="form-check-input custom-radio"></td>
                                    </tr>
                                </tbody>
                            </table>
                            <button id="clearRadioBtn" class="btn btn-outline-danger btn-sm" type="button"><i class="bi bi-eraser"></i> Clear Selections</button>
                        </div>

                        <div class="mt-4">
                            <label for="{{ form.remarks.id_for_label }}" class="form-label">General Remarks</label>
                            {{ form.remarks }}
                        </div>
                    </div>
                </div>

                <div class="text-center mb-5">
                    <div id="form-error" class="alert alert-danger d-none mb-3"></div>
                    <button id="submitBtn" type="submit" class="btn btn-primary btn-lg px-5">Create Reservation</button>
                    <button type="reset" class="btn btn-secondary btn-lg px-5">Reset</button>
                </div>

            </div>
        </div>
    </form>
</section>

<script>
    document.getElementById('clearRadioBtn').addEventListener('click', function(event) {
        event.preventDefault(); 
        document.querySelectorAll('.custom-radio:checked').forEach(radio => {
            radio.checked = false;
        });
    });

    document.getElementById('myform').addEventListener('submit', function(event) {
        let wearingConductChecked = document.querySelector('input[name="wearingconduct"]:checked');
        let rideGlassChecked = document.querySelector('input[name="rideglass"]:checked');
        let wearingConductError = document.getElementById('wearingconduct-error');
        let rideGlassError = document.getElementById('rideglass-error');
        let formError = document.getElementById('form-error');
        let submitBtn = document.getElementById('submitBtn');
    
        wearingConductError.textContent = "";
        rideGlassError.textContent = "";
        formError.classList.add('d-none');
    
        let hasError = false;
        if (!wearingConductChecked) { wearingConductError.textContent = "Required !"; hasError = true; }
        if (!rideGlassChecked) { rideGlassError.textContent = "Required !"; hasError = true; }
    
        if (hasError) {
            formError.textContent = "There are errors in the form. Please fix them before submitting.";
            formError.classList.remove('d-none');
            event.preventDefault();
        } else {
            submitBtn.disabled = true;
            submitBtn.innerText = 'Submitting...';
        }
    });

    document.addEventListener('DOMContentLoaded', function () {
        const mobileField = document.getElementById('id_mobile');
        const messageSpan = document.getElementById('mobile-validation-message');
        
        mobileField.addEventListener('blur', function () {
            const mobile = mobileField.value;
            if (mobile) {
                fetch(`/validate-mobile/?mobile=${mobile}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.exists) {
                            messageSpan.innerHTML = "A patient with this Mobile Number already exists. ";
                            const link = document.createElement("a");
                            link.href = `/centerReservationByMobile/${mobile}`;
                            link.target = "_blank";
                            link.innerText = "Click here to view";
                            messageSpan.appendChild(link);
                            messageSpan.style.display = 'block';
                        } else {
                            messageSpan.style.display = 'none';
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        });
    });
</script>
{%endblock%}