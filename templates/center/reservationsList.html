{% extends 'master.html' %}

{% block content %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css">

<style>
    /* High Visibility Search Bar */
    .dataTables_wrapper .dataTables_filter {
        float: none !important;
        text-align: left !important;
        background: #f1f4f9;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        border: 1px solid #e0e6ed;
    }
    .dataTables_wrapper .dataTables_filter input {
        width: 100% !important;
        max-width: 400px;
        margin-left: 10px !important;
        border: 2px solid #4154f1 !important;
        border-radius: 8px !important;
        padding: 8px 15px !important;
        background-color: white !important;
        box-shadow: 0 2px 4px rgba(65, 84, 241, 0.1);
    }

    /* Icon Styling */
    .action-stack {
        display: flex;
        gap: 8px;
        justify-content: center;
    }
    .btn-circle {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        border: none;
    }
    .btn-circle:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    /* Column specifically for the File Serial */
    .serial-box {
        background: #eef2ff;
        color: #4154f1;
        padding: 4px 8px;
        border-radius: 6px;
        font-family: 'Courier New', monospace;
        font-weight: bold;
    }
</style>

<div class="pagetitle">
    <h1>Reservation List <span class="badge bg-primary-light text-primary border ms-2">{{viewScope}}</span></h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{%url 'index'%}">Home</a></li>
            <li class="breadcrumb-item">Center</li>
            <li class="breadcrumb-item active">Reservations List</li>
        </ol>
    </nav>
</div>

<section class="section">
    <div class="card border-0 shadow-sm">
        <div class="card-body pt-4">
            
            <div class="table-responsive">
                <table id="patientsTable" class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>ID / File Serial</th>
                            <th>Patient Information</th>
                            <th>Medical Case</th>
                            <th>Timeline</th>
                            <th>Fee</th>
                            <th>Call Status</th>
                            <th>Created by</th>
                            <th>Created Date</th>
                            <th class="text-center">Quick Actions</th>
                            
                        </tr>
                    </thead>
                    <tbody>
                        {% for patient in patients %}
                        <tr>
                            <td>
                                <div class="serial-box mb-1 text-center">{{ patient.fileserial }}</div>
                                <div class="text-muted text-center small">Code: {{ patient.reservationCode|default:"N/A" }}</div>
                            </td>
                            <td>
                                <div class="fw-bold mb-0" style="font-size: 1rem; color: #012970;">{{ patient.fullname }}</div>
                                <div class="text-muted small"><i class="bi bi-phone me-1"></i>{{ patient.mobile }}</div>
                            </td>
                            <td>
                                <div class="d-flex flex-column gap-1">
                                    <span class="badge bg-light text-dark border w-100 text-start text-wrap"><i class="bi bi-telephone-inbound me-1 text-primary"></i> {{ patient.sufferedcase__caseName }}</span>
                                    <span class="badge bg-light text-dark border w-100 text-start text-wrap"><i class="bi bi-clipboard2-pulse me-1 text-danger"></i> {{ patient.sufferedcaseByPatient__caseName }}</span>
                                </div>
                            </td>
                            <td>
                                <div class="small"><span class="text-muted small fw-bold">ATT:</span> {{ patient.attendanceDate|date:"d M" }}</div>
                                <div class="small"><span class="text-muted small fw-bold">EXP:</span> {{ patient.expectedDate|date:"d M" }}</div>
                            </td>
                            <td>
                                <span class="fw-bold text-dark">{{ patient.checkUpprice__checkupPriceName }}</span>
                            </td>
                            <td>
                                <div class="d-flex align-items-center mb-1">
                                    <span class="badge bg-primary me-2">{{ patient.call_count }}</span>
                                    <span class="text-muted small">Attempts</span>
                                </div>
                                {% if patient.last_call_outcome %}
                                    <div class="small fw-bold {% if patient.last_call_outcome == 'Eye surgery' %}text-success{% else %}text-info{% endif %}">
                                        {{ patient.last_call_outcome }}
                                    </div>
                                {% endif %}
                            </td>
                              <td>{{ patient.createdBy__username }}</td>
            <td>{{ patient.createdDate|date:"Y-m-d H:i" }}</td>
          
                            <td>
                                <div class="action-stack">
                                    <a href="{% url 'followup' patient.patientid %}" 
                                       class="btn-circle bg-warning text-dark" 
                                       data-bs-toggle="tooltip" title="Add Follow-up">
                                        <i class="bi bi-arrow-repeat fs-5"></i>
                                    </a>
                                    
                                    <a target="_blank" href="{% url 'patientForm' patient.patientid %}" 
                                       class="btn-circle bg-info text-white" 
                                       data-bs-toggle="tooltip" title="Print Medical Form"
                                       onclick="return checkMedicalRecords('{{ patient.fileserial }}')">
                                        <i class="bi bi-file-earmark-pdf fs-5"></i>
                                    </a>
                                    
                                    <a href="{% url 'centeredit_reservation' patient.patientid %}" 
                                       class="btn-circle bg-primary text-white" 
                                       data-bs-toggle="tooltip" title="Edit Reservation">
                                        <i class="bi bi-pencil-square fs-5"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>

<script>
    $(document).ready(function () {
    if ($.fn.DataTable.isDataTable('#patientsTable')) {
        $('#patientsTable').DataTable().destroy();
    }

    $('#patientsTable').DataTable({
        paging: true,
        searching: true,
        lengthChange: false,
        info: false,
        pageLength: 25,

        order: [],        // ✅ keep backend order
        ordering: false,   // ✅ MUST be true for search to work reliably

        language: {
            search: "SEARCH PATIENT:",
            searchPlaceholder: "Search by Name or File Serial Number..."
        }
    });
});

</script>
{% endblock %}