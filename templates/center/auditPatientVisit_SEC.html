{%extends 'master.html'%}
{% load static%}

  {% block header %}
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script> 
    
  <link rel="stylesheet" href="{% static 'assets/css/doctorExam.css' %}">


  {% endblock %}
  {% block content %}
  <style>
  .container {
    width: 90%;
    max-width: 1000px;
    display: grid;
    grid-template-rows: auto auto 1fr;
    gap: 15px;
    
  }

  /* Search Bar Container */
.search-bar {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
  margin: 25px 0;
  width: 100%;
}

/* Input Field */
.search-bar input {
  width: 300px;
  padding: 12px 16px;
  font-size: 18px;
  border: 1px solid #CBD5E1;  /* Light gray border */
  border-radius: 12px;
  outline: none;
  transition: all 0.2s ease-in-out;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
}

.search-bar input:focus {
  border-color: #2563EB; /* Corporate Blue */
  box-shadow: 0 2px 8px rgba(37, 99, 235, 0.25);
}

/* Search Button */
.search-bar button {
  padding: 12px 30px;
  font-size: 18px;
  font-weight: bold;
  background: #2563EB;   /* Corporate Blue */
  color: white;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
}

.search-bar button:hover {
  background: #1E40AF;   /* Darker Blue */
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3);
}

  /* Loader */
  .loader {
    display: none;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #195a7a;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: auto;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
/* General Page Background */
body {
  background: #F1F5F9;  /* Light gray */
  font-family: "Segoe UI", Tahoma, sans-serif;
}

/* Top bar */
.top-bar {
  background: #1E293B;  /* Dark navy */
  color: white;
  font-size: 48px;
  font-weight: bold;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-radius: 10px;
}
.top-bar .percent {
  color: #22BD44FF; /* Gold */
  font-size: 42px;
}

/* Middle section (Patient Info) */
.middle-bar {
  background: #334155;  /* Slate gray */
  color: white;
  display: flex;
  justify-content: space-around;
  align-items: center;
  padding: 15px;
  border-radius: 10px;
  font-size: 20px;
  font-weight: bold;
}
.patient-info {
  background: #475569;  /* Subtle gray-blue */
  padding: 10px 20px;
  border-radius: 8px;
  margin: 5px;
  color: white;
}
</style>
  <div class="pagetitle">
     <!-- Store JSON Safely -->

    <h1>Audit Examination </h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{%url 'index'%}">Home</a></li>
        <li class="breadcrumb-item">Audit</li>
        <li class="breadcrumb-item active">Audit Examination</li>
      </ol>
    </nav>
  </div><!-- End Page Title -->
  <section class="section">

    <!-- üîç Modern Search Bar -->
<div class="search-bar">
  <input type="text" style="width: 70%;" id="fileNumber" placeholder="Please write or scan file serial">
  <button onclick="searchPatient()">
    Search
  </button>
</div>


    <!-- Loader -->
    <div id="loader" class="loader"></div>
  
    

    <!-- Middle bar (Patient Info) -->
    <div class="middle-bar" id="patient-info">
      

      <div class="patient-info">Patient Name: -</div>
      <div class="patient-info">File Serial: -</div>
      <div class="patient-info">Age: -</div>
    </div>   
<hr>
              <div class="form-container">
                <form method="post" name="vsitForm" action="AuditEvaluation" validate>
                    {% csrf_token %}
            
                    <input type="hidden"  name="hdfpatientid" id="hdfpatientid">

            
                    <div class="mb-4">
                     
                      <div class="d-flex flex-wrap gap-3 align-items-center">
                          <div class="form-check custom-radio">
                              <input type="radio" name="gridRadios" id="gridRadios1" value="OK">
                              <label for="gridRadios1" >
                                  <span class="circle bg-green"></span>
                                 OK
                              </label>
                          </div>
                          <div class="form-check custom-radio">
                              <input type="radio" name="gridRadios" id="gridRadios2" value="++">
                              <label for="gridRadios2">
                                  <span class="circle bg-orange" ></span>
                                <span style="font-size: 24px;">++</span> 
                              </label>
                          </div>
                          <div class="form-check custom-radio">
                              <input type="radio" name="gridRadios" id="gridRadios3" value="Surgery">
                              <label for="gridRadios3">
                                  <span class="circle bg-pink"></span>
                                  Surgery
                              </label>
                          </div>
                          <div class="form-check custom-radio">
                              <input type="radio" name="gridRadios" id="gridRadios4" value="6/6">
                              <label for="gridRadios4">
                                  <span class="circle bg-white"></span>
                                  <span style="font-size: 18px;">6/6</span> 
                              </label>
                          </div>
                          <div class="form-check custom-radio">
                              <input type="radio" name="gridRadios" id="gridRadios5" value="Bad">
                              <label for="gridRadios5">
                                  <span class="circle bg-yellow"></span>
                                  Bad
                              </label>
                          </div>
                      </div>
                  </div>
                  <input type="hidden" id="hdfSelectSubCategory" name="selectedOption" value="">
                  
                  <br/>
                  
                  
            
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-lg">Submit</button>
                        <button type="reset" class="btn btn-secondary btn-lg">Reset</button>
                    </div>
                </form>
            </div>
            
            
            </div>
        
      
     
    </div>
   
  </section>
  <!-- Modal Structure -->
  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Selection Confirmed</h5>
                <!-- Restyled Close Button -->
                <button type="button" class="btn-close custom-close-btn" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" >
                <!-- Content will be set dynamically by JavaScript -->
<div id="modalBody"></div>
<label for="selectControl">Choose an Option:</label>
<select id="selectControl" class="form-select mt-3">
  <option selected disabled>Select an option</option>
 
</select>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
    </div>
  </div>


  <script>
 
  
  const classifiedOptions = JSON.parse('{{ classifiedOptionsJSON|safe }}');

  const modalBody = document.getElementById('modalBody');
  const dropdown = document.getElementById('selectControl');
  const modalElement = document.getElementById('exampleModal');
  //const modal = new bootstrap.Modal(modalElement);
  const hiddenInput = document.getElementById('hdfSelectSubCategory'); // Hidden input to store the value
  
  // Initialize Bootstrap Modal with options
  const modal = new bootstrap.Modal(modalElement, {
    backdrop: 'static', // Prevent modal from closing when clicking on backdrop
    keyboard: false     // Disable closing modal with Esc key
  });
  // Function to update dropdown options
  const updateDropdown = (selectedValue) => {
      const filteredOptions = classifiedOptions.filter(option => 
          option.classifiedCategory === selectedValue
      );
      dropdown.innerHTML = '<option selected disabled>Select an option</option>';
      filteredOptions.forEach(option => {
          const opt = document.createElement('option');
          opt.value = option.classifiedID;
          opt.textContent = option.optionClassified;
          dropdown.appendChild(opt);
      });
  };
  
  // Handle radio button changes
  document.querySelectorAll('.custom-radio input').forEach((input) => {
      input.addEventListener('change', function () {
          document.querySelectorAll('.custom-radio').forEach((radio) => {
              radio.classList.remove('active');
          });
          this.parentElement.classList.add('active');
  
          const selectedValue = this.value;
          modalBody.innerHTML = `You selected: <strong>${selectedValue}</strong>`;
          updateDropdown(selectedValue);
          modal.show();
      });
  });
  
  // Handle modal close to store dropdown value
  modalElement.addEventListener('hidden.bs.modal', () => {
  const selectedDropdownValue = dropdown.value;
  if (selectedDropdownValue) {
    hiddenInput.value = selectedDropdownValue; // Store the selected value in hidden input
    console.log("Stored value in hidden input:", hiddenInput.value);
  } else {
    console.log("No value selected from dropdown.");
  }
  });
  </script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const input = document.getElementById("fileNumber");
    input.focus(); // cursor ready for scanning

    // listen for Enter after scanning
    input.addEventListener("keypress", function (event) {
      if (event.key === "Enter") {
        event.preventDefault(); // stop form submitting
        searchPatient(); // run search automatically
      }
    });
  });
</script>


  <script>
  async function searchPatient() {
    const fileNumber = document.getElementById("fileNumber").value.trim();
    const loader = document.getElementById("loader");
    const patientInfoBox = document.getElementById("patient-info");


   

    if (!fileNumber) {
      alert("‚ö†Ô∏è Please Add file serial");
      return;
    }

    try {
      // Show loader
      loader.style.display = "block";
      patientInfoBox.innerHTML = ""; // Clear old info

      // Fetch from Django endpoint
      const response = await fetch(`/get_patient_info/${encodeURIComponent(fileNumber)}/`);

      if (!response.ok) {
        throw new Error("Can find patient by this file number");
      }

      const data = await response.json();

      if (data && Object.keys(data).length > 0) {
        showForm(); // Show the form when patient is found
        // Update patient info
        patientInfoBox.innerHTML = `
          <div class="patient-info"><strong>Patient Name:</strong> ${data.name || "-"}</div>
          <div class="patient-info"><strong>File Serial:</strong> ${data.fileserial || "-"}</div>
          <div class="patient-info"><strong>Age:</strong> ${data.age || "-"}</div>
        `;

        // Fill hidden field
        document.getElementById("hdfpatientid").value = data.patientID || "";

       
      } else {
        throw new Error("‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸáÿ∞ÿß ÿßŸÑŸÖÿ±Ÿäÿ∂");
      }
    } catch (error) {
      alert(error.message || "ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ¨ŸÑÿ® ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™");
      console.error(error);
    } finally {
      loader.style.display = "none";
    }
  }

   function showForm() {
      const formContainer = document.querySelector(".form-container");
      formContainer.classList.add("show");
  }
</script>


  {% endblock %}
